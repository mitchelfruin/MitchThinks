---
title: "Small extreme samples."
author: "Mitchel Fruin"
date: "2019-10-26"
description: "Add description."
tags: ["Behavioural Economics", "Probability and Statistics"]
slug: extreme_samples
draft: true
output:
  blogdown::html_page:
    toc: true
    toc_depth: 2
    number_sections: true
---

<style type="text/css">
div#TOC li {
    list-style:none;
    background-image:none;
    background-repeat:none;
    background-position:0; 
}
</style>

```{r setup, include=FALSE}
# RMarkdown
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.align = "center",
                      fig.width = 8.09,
                      fig.height = 5)

# Packages
library(tidyverse)
library(magrittr)
library(plotly)
library(funnelR)
```

K&T hospital scenario. 

The date are discussed in a blog by Paul Barden on the [Understanding Uncertainty site](https://understandinguncertainty.org/three-fold-variation-uk-bowel-cancer-death-rates)

and on his [own blog](https://pb204.blogspot.com/2011/09/im-grateful-to-david-spiegelhalter-of.html). Note that data for Wales is not included, as it was reported for the whole of Wales rather than by region.

Get the data: 

```{r}
bowel_data <- read.csv("https://raw.githubusercontent.com/dspiegel29/ArtofStatistics/master/09-2-funnel-bowel-cancer/09-2-bowel-cancer-data-x.csv")
```

Get it all prepped:

```{r}
head(bowel_data)
mean_prop <- sum(bowel_data$n)/sum(bowel_data$d)
max_props <- max(bowel_data$n/bowel_data$d)

# Numerator must be called n, denomnator d
funnel_limits <- fundata(input = bowel_data,
                         benchmark = mean_prop,
                         alpha = 0.95,
                         alpha2 = 0.998,
                         method = 'approximate',
                         step = 100)

glasgow <- subset(bowel_data, District == "Glasgow City")  # identify Glasgow City in data frame
```

Visualise manually:

```{r}
bowel_data %<>% mutate(prop_death = n/d)

# Lowest pop 31332, find funnel limits at 31001
up_limit <- filter(funnel_limits, d == 31001) %>%
  pull(up2)
low_limit <- filter(funnel_limits, d == 31001) %>%
  pull(lo2)

ggplot() +
  geom_point(aes(x = d, y = prop_death), data = bowel_data) +
  geom_hline(yintercept = mean_prop) +
  geom_ribbon(aes(x = d, ymin = lo, ymax = up),
              data = funnel_limits,
              fill = "blue",
              alpha = 0.4) +
  geom_ribbon(aes(x = d, ymin = lo2, ymax = up2),
              data = funnel_limits,
              fill = "purple",
              alpha = 0.2) +
  scale_y_continuous("Annual bowel cancer mortality rate per 100,000",
                     breaks = 5*(0:8)/100000,
                     labels = 5*(0:8),
                     limits = c(low_limit, up_limit)) + 
  scale_x_continuous("Population (100,000's)",
                     breaks = 100000*(0:14),
                     labels = 0:14,
                     limits = c(0, max(bowel_data$d))) +
  theme_classic() +
  theme(panel.grid.major = element_line()) + 
  annotate("text", 
           x = glasgow$d,
           y = glasgow$n/glasgow$d,
           label = "Glasgow City",
           hjust = -0.05,
           vjust = 1)
```

How many of the observations fall within the bounds? Suspiciously good match 

Visualise with out of box:

Bill & Melinda Gates Foundation example of it gone wrong. 
